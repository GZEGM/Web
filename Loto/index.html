<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hệ Thống Loto Online Pro</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Roboto", sans-serif;
      }
      .loto-cell {
        aspect-ratio: 1/1;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid;
        font-weight: 900;
        font-size: 1.5rem;
        background-color: white;
        /* Prevent numbers from looking "chạm nóc" (esp. in html2canvas) */
        padding-top: 2px;
        padding-bottom: 15px;
        margin: 0;
        line-height: 1.15;
        white-space: nowrap;
        overflow: hidden;
      }
      /* Theme styles sẽ được apply qua class cha */

      /* Theme Red (Default) */
      .theme-red .loto-cell {
        border-color: #e5e7eb;
      }
      .theme-red .loto-cell.has-number {
        background-color: #fffbeb;
        color: #b91c1c;
        border-color: #fca5a5;
      }
      .theme-red .ticket-border {
        border-color: #ef4444;
        background-color: white;
      }
      .theme-red .ticket-header {
        color: #dc2626;
        border-bottom-color: #fecaca;
      }
      .theme-red .grid-bg {
        background-color: #fef2f2;
        border-color: #fee2e2;
      }

      /* Theme Blue */
      .theme-blue .loto-cell {
        border-color: #e5e7eb;
      }
      .theme-blue .loto-cell.has-number {
        background-color: #eff6ff;
        color: #1d4ed8;
        border-color: #93c5fd;
      }
      .theme-blue .ticket-border {
        border-color: #3b82f6;
        background-color: white;
      }
      .theme-blue .ticket-header {
        color: #2563eb;
        border-bottom-color: #bfdbfe;
      }
      .theme-blue .grid-bg {
        background-color: #eff6ff;
        border-color: #dbeafe;
      }

      /* Theme Green */
      .theme-green .loto-cell {
        border-color: #e5e7eb;
      }
      .theme-green .loto-cell.has-number {
        background-color: #f0fdf4;
        color: #15803d;
        border-color: #86efac;
      }
      .theme-green .ticket-border {
        border-color: #22c55e;
        background-color: white;
      }
      .theme-green .ticket-header {
        color: #16a34a;
        border-bottom-color: #bbf7d0;
      }
      .theme-green .grid-bg {
        background-color: #f0fdf4;
        border-color: #dcfce7;
      }

      /* Theme Purple */
      .theme-purple .loto-cell {
        border-color: #e5e7eb;
      }
      .theme-purple .loto-cell.has-number {
        background-color: #faf5ff;
        color: #7e22ce;
        border-color: #d8b4fe;
      }
      .theme-purple .ticket-border {
        border-color: #a855f7;
        background-color: white;
      }
      .theme-purple .ticket-header {
        color: #9333ea;
        border-bottom-color: #e9d5ff;
      }
      .theme-purple .grid-bg {
        background-color: #faf5ff;
        border-color: #f3e8ff;
      }

      /* Theme White (new default) */
      .theme-white .loto-cell {
        border-color: #e5e7eb;
      }
      .theme-white .loto-cell.has-number {
        background-color: #ffffff;
        color: #111827;
        border-color: #d1d5db;
      }
      .theme-white .ticket-border {
        border-color: #111827;
        background-color: white;
      }
      .theme-white .ticket-header {
        color: #111827;
        border-bottom-color: #e5e7eb;
      }
      .theme-white .grid-bg {
        background-color: #ffffff;
        border-color: #e5e7eb;
      }

      .ticket-container {
        background-image: radial-gradient(
          rgba(0, 0, 0, 0.1) 1px,
          transparent 1px
        );
        background-size: 20px 20px;
      }
      .tab-active {
        border-bottom: 2px solid #dc2626;
        color: #dc2626;
      }
      .tab-inactive {
        color: #6b7280;
      }
      #bulk-render-container {
        position: fixed;
        top: -9999px;
        left: -9999px;
        width: 400px;
      }
      /* Animation for stats */
      @keyframes countUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .stat-card {
        animation: countUp 0.5s ease-out forwards;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Navbar -->
    <nav
      class="bg-gradient-to-r from-red-700 to-red-600 text-white shadow-lg sticky top-0 z-50"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-2">
            <div
              class="bg-white p-1 rounded-full text-red-600 w-8 h-8 flex items-center justify-center shadow-sm"
            >
              <i class="fa-solid fa-ticket text-lg"></i>
            </div>
            <span class="font-bold text-xl uppercase tracking-tighter"
              >Loto Pro</span
            >
          </div>
          <div class="flex items-center gap-4">
            <button
              onclick="window.logout()"
              class="text-xs bg-red-800 hover:bg-red-900 py-1 px-3 rounded text-white transition"
            >
              <i class="fa-solid fa-right-from-bracket"></i> Thoát
            </button>
            <span
              id="user-display"
              class="hidden sm:block text-sm font-medium bg-white/20 py-1 px-3 rounded-full backdrop-blur-sm"
            ></span>
          </div>
        </div>
      </div>
    </nav>

    <!-- App Main -->
    <main
      class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-6"
      id="main-app"
      style="display: none"
    >
      <!-- Tabs -->
      <div
        class="flex border-b border-gray-200 mb-6 overflow-x-auto bg-white rounded-t-lg px-2 shadow-sm"
      >
        <button
          onclick="window.switchTab('generate')"
          id="tab-generate"
          class="tab-active py-3 px-6 font-bold text-sm whitespace-nowrap transition-colors duration-200"
        >
          <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Tạo Vé
        </button>
        <button
          onclick="window.switchTab('history')"
          id="tab-history"
          class="tab-inactive py-3 px-6 font-medium text-sm whitespace-nowrap transition-colors duration-200"
        >
          <i class="fa-solid fa-clock-rotate-left mr-2"></i>Kho Vé Của Tôi
        </button>
        <button
          onclick="window.switchTab('custom')"
          id="tab-custom"
          class="tab-inactive py-3 px-6 font-medium text-sm whitespace-nowrap transition-colors duration-200"
        >
          <i class="fa-solid fa-pen-ruler mr-2"></i>Tự Tạo Vé
        </button>
        <button
          onclick="window.switchTab('admin')"
          id="tab-admin"
          class="hidden tab-inactive py-3 px-6 font-medium text-sm whitespace-nowrap text-purple-600 transition-colors duration-200"
        >
          <i class="fa-solid fa-user-shield mr-2"></i>Quản Trị Admin
        </button>
      </div>

      <!-- View: Generate -->
      <div id="view-generate" class="block animate-fade-in">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
          <!-- Controls Panel -->
          <div class="lg:col-span-5 space-y-6">
            <div
              class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"
            >
              <h2
                class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"
              >
                <i class="fa-solid fa-sliders text-red-500"></i> Cấu Hình Vé
              </h2>

              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Chọn Màu Vé</label
                >
                <div class="grid grid-cols-5 gap-2">
                  <button
                    onclick="window.setTheme('white')"
                    class="h-10 rounded-lg bg-white border-2 border-gray-900 hover:scale-105 transition"
                    title="Trắng"
                  ></button>
                  <button
                    onclick="window.setTheme('red')"
                    class="h-10 rounded-lg bg-red-100 border-2 border-red-500 hover:scale-105 transition"
                  ></button>
                  <button
                    onclick="window.setTheme('blue')"
                    class="h-10 rounded-lg bg-blue-100 border-2 border-transparent hover:border-blue-500 hover:scale-105 transition"
                  ></button>
                  <button
                    onclick="window.setTheme('green')"
                    class="h-10 rounded-lg bg-green-100 border-2 border-transparent hover:border-green-500 hover:scale-105 transition"
                  ></button>
                  <button
                    onclick="window.setTheme('purple')"
                    class="h-10 rounded-lg bg-purple-100 border-2 border-transparent hover:border-purple-500 hover:scale-105 transition"
                  ></button>
                </div>
              </div>

              <button
                onclick="window.generateRandomTicket()"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg shadow-indigo-200 transition active:scale-[0.98] flex items-center justify-center gap-2 mb-4"
              >
                <i class="fa-solid fa-shuffle"></i> Ngẫu Nhiên Vé Mới
              </button>

              <div class="grid grid-cols-2 gap-3">
                <button
                  onclick="window.confirmTicket()"
                  id="btn-confirm"
                  disabled
                  class="bg-green-600 hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-xl shadow transition active:scale-[0.98] flex items-center justify-center gap-2"
                >
                  <i class="fa-solid fa-floppy-disk"></i> Lưu Vé
                </button>
                <button
                  onclick="window.downloadTicketImage('ticket-preview')"
                  id="btn-download-img"
                  disabled
                  class="bg-orange-500 hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-xl shadow transition active:scale-[0.98] flex items-center justify-center gap-2"
                >
                  <i class="fa-solid fa-download"></i> Tải Ảnh
                </button>
              </div>

              <p class="text-xs text-gray-400 mt-4 text-center italic">
                *Mỗi lần tạo ngẫu nhiên chỉ được lưu 1 lần duy nhất để tránh
                trùng lặp.
              </p>
            </div>
          </div>

          <!-- Preview Panel -->
          <div class="lg:col-span-7 flex justify-center items-start">
            <!-- Ticket Wrapper with Theme Class -->
            <div
              id="ticket-preview-wrapper"
              class="theme-white w-full flex justify-center"
            >
              <div
                id="ticket-preview"
                class="ticket-container ticket-border border-2 rounded-lg p-5 shadow-2xl w-full max-w-md relative overflow-hidden transition-all duration-300"
              >
                <div
                  class="text-center mb-5 border-b pb-3 ticket-header border-red-200"
                >
                  <h3 class="text-2xl font-black uppercase tracking-widest">
                    Vé Loto 9x9
                  </h3>
                  <div class="flex justify-between items-end mt-2 px-2">
                    <p
                      class="text-[10px] text-gray-500 font-mono"
                      id="preview-date"
                    >
                      --/--/----
                    </p>
                    <p class="text-sm font-bold" id="preview-user">...</p>
                  </div>
                </div>
                <div
                  id="loto-grid"
                  class="grid grid-cols-9 gap-1 grid-bg p-1.5 border rounded-sm"
                >
                  <div
                    class="col-span-9 text-center py-20 text-gray-400 italic text-sm"
                  >
                    Bấm "Ngẫu Nhiên" để tạo vé...
                  </div>
                </div>
                <div class="mt-2 text-center">
                  <span class="text-[10px] text-gray-400 font-mono"
                    >ID: <span id="preview-id">AUTO-GEN</span></span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- View: History -->
      <div id="view-history" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800">Kho Vé Của Tôi</h2>
          <span
            class="text-sm bg-gray-200 text-gray-700 py-1 px-3 rounded-full font-medium"
            id="history-count"
            >0 vé</span
          >
        </div>
        <div
          id="history-list"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
        ></div>
      </div>

      <!-- View: Custom Ticket -->
      <div id="view-custom" class="hidden animate-fade-in">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
          <!-- Controls Panel -->
          <div class="lg:col-span-5 space-y-6">
            <div
              class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"
            >
              <h2
                class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"
              >
                <i class="fa-solid fa-pen-ruler text-indigo-500"></i> Tự Tạo Vé
              </h2>

              <p class="text-sm text-gray-600 mb-4">
                Bạn có thể tự nhập số theo ý thích nhưng vẫn phải
                <span class="font-semibold text-red-600"
                  >tuân thủ quy tắc mỗi hàng, mỗi cột chỉ có đúng 5 số và trong
                  mỗi cột các số phải tăng dần từ trên xuống dưới.</span
                >
              </p>

              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Chọn màu số (RGB)</label
                >
                <div class="flex items-center gap-3">
                  <input
                    type="color"
                    id="custom-color-picker"
                    class="w-12 h-10 border border-gray-300 rounded cursor-pointer"
                    value="#ff0000"
                    onchange="window.setCustomColor(this.value)"
                  />
                  <div class="flex gap-2 text-xs text-gray-600">
                    <span
                      class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 rounded"
                    >
                      <span class="w-2 h-2 bg-red-500 rounded-full"></span>R
                    </span>
                    <span
                      class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 rounded"
                    >
                      <span class="w-2 h-2 bg-green-500 rounded-full"></span>G
                    </span>
                    <span
                      class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 rounded"
                    >
                      <span class="w-2 h-2 bg-blue-500 rounded-full"></span>B
                    </span>
                  </div>
                </div>
                <p class="mt-2 text-xs text-gray-500">
                  Màu này sẽ áp dụng cho các ô có số trên vé tùy chọn.
                </p>
              </div>

              <div class="grid grid-cols-2 gap-3 mt-4">
                <button
                  onclick="window.resetCustomTicket()"
                  class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2.5 px-3 rounded-lg text-sm flex items-center justify-center gap-2"
                >
                  <i class="fa-solid fa-eraser"></i> Xóa hết
                </button>
                <button
                  onclick="window.validateAndPreviewCustomTicket()"
                  class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-3 rounded-lg shadow text-sm flex items-center justify-center gap-2"
                >
                  <i class="fa-solid fa-eye"></i> Kiểm tra & xem trước
                </button>
              </div>

              <button
                onclick="window.downloadTicketImage('custom-ticket-preview')"
                id="btn-download-custom-img"
                disabled
                class="mt-4 w-full bg-orange-500 hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-xl shadow transition active:scale-[0.98] flex items-center justify-center gap-2 text-sm"
              >
                <i class="fa-solid fa-download"></i> Tải Ảnh Vé Tùy Chọn
              </button>
            </div>
          </div>

          <!-- Preview + Editable Grid -->
          <div class="lg:col-span-7 flex justify-center items-start">
            <div class="w-full flex justify-center">
              <div
                id="custom-ticket-preview"
                class="ticket-container ticket-border border-2 rounded-lg p-5 shadow-2xl w-full max-w-md relative overflow-hidden transition-all duration-300 bg-white"
              >
                <div
                  class="text-center mb-5 border-b pb-3 ticket-header border-gray-200"
                >
                  <h3 class="text-2xl font-black uppercase tracking-widest">
                    Vé Loto 9x9 - Tùy Chọn
                  </h3>
                  <div class="flex justify-between items-end mt-2 px-2">
                    <p
                      class="text-[10px] text-gray-500 font-mono"
                      id="custom-preview-date"
                    >
                      --/--/----
                    </p>
                    <p class="text-sm font-bold" id="custom-preview-user">
                      ...
                    </p>
                  </div>
                </div>
                <div
                  id="loto-grid-custom"
                  class="grid grid-cols-9 gap-1 grid-bg p-1.5 border rounded-sm bg-white"
                >
                  <!-- Filled bằng JS -->
                </div>
                <div class="mt-2 text-center">
                  <span class="text-[10px] text-gray-400 font-mono"
                    >ID: <span id="custom-preview-id">CUSTOM</span></span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- View: Admin -->
      <div id="view-admin" class="hidden">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div
            class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-indigo-100"
          >
            <div class="flex items-center gap-4">
              <div
                class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 text-xl"
              >
                <i class="fa-solid fa-ticket"></i>
              </div>
              <div>
                <p class="text-sm text-gray-500 font-medium">Tổng số vé</p>
                <h3
                  class="text-2xl font-bold text-gray-800"
                  id="stat-total-tickets"
                >
                  0
                </h3>
              </div>
            </div>
          </div>
          <div
            class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-emerald-100"
            style="animation-delay: 0.1s"
          >
            <div class="flex items-center gap-4">
              <div
                class="w-12 h-12 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 text-xl"
              >
                <i class="fa-solid fa-users"></i>
              </div>
              <div>
                <p class="text-sm text-gray-500 font-medium">Người chơi</p>
                <h3
                  class="text-2xl font-bold text-gray-800"
                  id="stat-total-users"
                >
                  0
                </h3>
              </div>
            </div>
          </div>
          <div
            class="stat-card bg-white p-6 rounded-2xl shadow-sm border border-orange-100"
            style="animation-delay: 0.2s"
          >
            <div class="flex items-center gap-4">
              <div
                class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 text-xl"
              >
                <i class="fa-solid fa-clock"></i>
              </div>
              <div>
                <p class="text-sm text-gray-500 font-medium">Mới nhất</p>
                <h3
                  class="text-lg font-bold text-gray-800 line-clamp-1"
                  id="stat-last-user"
                >
                  ...
                </h3>
              </div>
            </div>
          </div>
        </div>

        <!-- Detailed Stats -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8">
          <div class="lg:col-span-5 bg-white p-6 rounded-2xl shadow-sm border">
            <h3
              class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"
            >
              <i class="fa-solid fa-chart-simple text-indigo-600"></i> Thống kê
              nhanh
            </h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4">
                <div class="text-xs font-bold text-indigo-700 uppercase">
                  Hôm nay
                </div>
                <div
                  class="text-2xl font-black text-indigo-900"
                  id="stat-tickets-today"
                >
                  0
                </div>
              </div>
              <div
                class="bg-emerald-50 border border-emerald-100 rounded-xl p-4"
              >
                <div class="text-xs font-bold text-emerald-700 uppercase">
                  7 ngày gần đây
                </div>
                <div
                  class="text-2xl font-black text-emerald-900"
                  id="stat-tickets-7d"
                >
                  0
                </div>
              </div>
              <div
                class="bg-orange-50 border border-orange-100 rounded-xl p-4 col-span-2"
              >
                <div class="text-xs font-bold text-orange-700 uppercase">
                  Top người chơi
                </div>
                <div class="flex justify-between items-end gap-3">
                  <div
                    class="text-lg font-black text-orange-900 truncate"
                    id="stat-top-user"
                  >
                    ---
                  </div>
                  <div
                    class="text-sm font-bold text-orange-800 whitespace-nowrap"
                  >
                    <span id="stat-top-user-count">0</span> vé
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="lg:col-span-7 bg-white p-6 rounded-2xl shadow-sm border">
            <h3
              class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"
            >
              <i class="fa-solid fa-palette text-purple-600"></i> Tỷ lệ màu vé
            </h3>
            <div class="space-y-3 text-sm">
              <div>
                <div class="flex justify-between items-center mb-1">
                  <div class="font-bold text-gray-700">WHITE</div>
                  <div class="text-gray-500" id="theme-white-text">0 (0%)</div>
                </div>
                <div
                  class="w-full h-2 bg-gray-200 rounded-full overflow-hidden"
                >
                  <div
                    id="theme-white-fill"
                    class="h-2 bg-gray-900"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between items-center mb-1">
                  <div class="font-bold text-gray-700">RED</div>
                  <div class="text-gray-500" id="theme-red-text">0 (0%)</div>
                </div>
                <div
                  class="w-full h-2 bg-gray-200 rounded-full overflow-hidden"
                >
                  <div
                    id="theme-red-fill"
                    class="h-2 bg-red-500"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between items-center mb-1">
                  <div class="font-bold text-gray-700">BLUE</div>
                  <div class="text-gray-500" id="theme-blue-text">0 (0%)</div>
                </div>
                <div
                  class="w-full h-2 bg-gray-200 rounded-full overflow-hidden"
                >
                  <div
                    id="theme-blue-fill"
                    class="h-2 bg-blue-500"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between items-center mb-1">
                  <div class="font-bold text-gray-700">GREEN</div>
                  <div class="text-gray-500" id="theme-green-text">0 (0%)</div>
                </div>
                <div
                  class="w-full h-2 bg-gray-200 rounded-full overflow-hidden"
                >
                  <div
                    id="theme-green-fill"
                    class="h-2 bg-green-500"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between items-center mb-1">
                  <div class="font-bold text-gray-700">PURPLE</div>
                  <div class="text-gray-500" id="theme-purple-text">0 (0%)</div>
                </div>
                <div
                  class="w-full h-2 bg-gray-200 rounded-full overflow-hidden"
                >
                  <div
                    id="theme-purple-fill"
                    class="h-2 bg-purple-500"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border mb-8">
          <h3
            class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"
          >
            <i class="fa-solid fa-ranking-star text-yellow-500"></i> Top người
            chơi (theo số vé)
          </h3>
          <div
            id="admin-user-breakdown"
            class="grid grid-cols-1 md:grid-cols-2 gap-3"
          ></div>
        </div>

        <!-- Controls & Table -->
        <div
          class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"
        >
          <div class="relative w-full md:w-64">
            <i
              class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
            ></i>
            <input
              oninput="window.filterAdminTable(this.value)"
              type="text"
              placeholder="Tìm tên người chơi..."
              class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm"
            />
          </div>
          <div class="flex flex-wrap gap-2">
            <button
              onclick="window.downloadAllTickets()"
              class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2.5 px-4 rounded-lg shadow transition flex items-center gap-2"
            >
              <i class="fa-solid fa-images"></i> Tải Tất Cả Ảnh
            </button>
            <button
              onclick="window.exportToExcel()"
              class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2.5 px-4 rounded-lg shadow transition flex items-center gap-2"
            >
              <i class="fa-solid fa-file-excel"></i> Xuất Excel
            </button>
          </div>
        </div>

        <div
          class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200"
        >
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
                  >
                    Người Chơi
                  </th>
                  <th
                    class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
                  >
                    Màu Vé
                  </th>
                  <th
                    class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
                  >
                    Thời Gian
                  </th>
                  <th
                    class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
                  >
                    Hành Động
                  </th>
                </tr>
              </thead>
              <tbody
                id="admin-table-body"
                class="bg-white divide-y divide-gray-200 text-sm"
              ></tbody>
            </table>
          </div>
          <div
            id="admin-empty-state"
            class="hidden p-8 text-center text-gray-500"
          >
            Không tìm thấy dữ liệu phù hợp.
          </div>
        </div>
      </div>
    </main>

    <!-- Hidden Bulk Render -->
    <div id="bulk-render-container"></div>

    <!-- Login Modal -->
    <div
      id="modal-login"
      class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden animate-fade-in"
    >
      <div
        class="bg-white rounded-2xl max-w-sm w-full p-8 shadow-2xl transform transition-all scale-100"
      >
        <div class="text-center mb-6">
          <div
            class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"
          >
            <i class="fa-solid fa-gamepad"></i>
          </div>
          <h2 class="text-2xl font-bold text-gray-800">VÀO CHƠI LOTO</h2>
          <p class="text-gray-500 text-sm mt-1">Nhập tên của bạn để bắt đầu</p>
        </div>
        <input
          type="text"
          id="login-name"
          class="w-full px-4 py-3 rounded-lg border border-gray-300 mb-4 outline-none focus:ring-2 focus:ring-red-500 transition"
          placeholder="Ví dụ: Anh Ba, Chị Tư..."
        />
        <button
          onclick="window.handleLogin()"
          class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition shadow-lg shadow-red-200"
        >
          Xác Nhận
        </button>
      </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div
      id="modal-confirm"
      class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[105] flex items-center justify-center p-4 hidden"
    >
      <div class="bg-white rounded-2xl max-w-sm w-full p-6 shadow-2xl">
        <h3 class="text-xl font-bold text-gray-800 mb-2">Xóa Vé Này?</h3>
        <p class="text-gray-600 mb-6 text-sm">
          Bạn chắc chắn muốn xóa vé này chứ? Hành động này không thể hoàn tác.
        </p>
        <div class="flex justify-end gap-3">
          <button
            onclick="window.closeConfirm()"
            class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-medium"
          >
            Hủy
          </button>
          <button
            id="btn-confirm-delete"
            class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold shadow-md"
          >
            Xóa Luôn
          </button>
        </div>
      </div>
    </div>

    <!-- Custom Number Picker for Tự Tạo Vé (Moved OUTSIDE modal-confirm) -->
    <div
      id="custom-number-picker"
      class="fixed z-[120] bg-white border border-gray-200 rounded-lg shadow-xl p-3 hidden"
    >
      <div class="text-xs font-semibold text-gray-600 mb-2">
        Chọn số hợp lệ cho ô này
      </div>
      <div
        id="custom-number-picker-grid"
        class="grid grid-cols-5 gap-1 text-sm"
      ></div>
      <button
        id="custom-number-picker-clear"
        class="mt-2 w-full text-xs py-1.5 rounded bg-gray-100 text-gray-700 hover:bg-gray-200"
      >
        Xóa ô
      </button>
    </div>

    <!-- Toast Notifications -->
    <div
      id="toast"
      class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-2xl transform translate-y-24 opacity-0 transition-all duration-300 z-[110] text-sm font-medium flex items-center gap-3"
    >
      <i class="fa-solid fa-circle-info text-blue-400"></i>
      <span id="toast-msg"></span>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        onValue,
        remove,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDZK2CCPs323te_V6eq1osLdopV_yjtQp0",
        authDomain: "loto-e2b48.firebaseapp.com",
        databaseURL: "https://loto-e2b48-default-rtdb.firebaseio.com",
        projectId: "loto-e2b48",
        storageBucket: "loto-e2b48.firebasestorage.app",
        messagingSenderId: "537298300448",
        appId: "1:537298300448:web:b61879cd5a4aee5ac8d645",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const rtdb = getDatabase(app);
      const appId = window.__app_id || "default-app-loto-pro";
      const RTDB_PATH = `artifacts/${appId}/tickets`;

      let username = localStorage.getItem("loto_username") || "";
      // userId should be scoped per username to avoid "Kho vé của tôi" leaking across users on same device.
      // We still keep backward-compat by falling back to old `loto_userid` if present.
      let userId =
        localStorage.getItem(
          username ? `loto_userid__${username.trim().toLowerCase()}` : ""
        ) ||
        localStorage.getItem("loto_userid") ||
        "user_" + Date.now();
      localStorage.setItem("loto_userid", userId);
      if (username) {
        localStorage.setItem(
          `loto_userid__${username.trim().toLowerCase()}`,
          userId
        );
      }

      let isAdmin = username.trim().toLowerCase() === "admin";
      let currentTicket = null;
      let currentTheme = "white";
      let isCurrentTicketSaved = false;
      let allTickets = [];
      let pendingDeleteId = null;
      let customMatrix = Array(9)
        .fill(null)
        .map(() => Array(9).fill(null));
      let customColor = "#ff0000";
      let isCustomGridInitialized = false;
      let currentPickerCell = null;

      // Auth Flow
      const checkLoginStatus = () => {
        if (!username) {
          document.getElementById("modal-login").classList.remove("hidden");
        } else {
          signInAnonymously(auth);
        }
      };

      function initAppAfterLogin() {
        document.getElementById("modal-login").classList.add("hidden");
        document.getElementById("main-app").style.display = "block";
        document.getElementById(
          "user-display"
        ).textContent = `Xin chào, ${username}`;

        // Admin tab visibility
        const adminTab = document.getElementById("tab-admin");
        if (isAdmin) adminTab.classList.remove("hidden");
        else adminTab.classList.add("hidden");

        // If user is not admin, make sure they aren't stuck on admin view
        if (!isAdmin) {
          const adminView = document.getElementById("view-admin");
          if (adminView && !adminView.classList.contains("hidden")) {
            window.switchTab("generate");
          }
        }

        listenToTickets();
      }

      onAuthStateChanged(auth, (user) => {
        if (user && username) {
          initAppAfterLogin();
        }
      });

      window.handleLogin = () => {
        const val = document.getElementById("login-name").value.trim();
        if (!val) return showToast("Vui lòng nhập tên!");
        username = val;
        isAdmin = username.toLowerCase() === "admin";
        localStorage.setItem("loto_username", username);

        // Per-username userId to keep "Kho vé của tôi" truly personal on shared devices.
        const key = `loto_userid__${username.trim().toLowerCase()}`;
        userId = localStorage.getItem(key) || "user_" + Date.now();
        localStorage.setItem(key, userId);
        localStorage.setItem("loto_userid", userId);

        // Fix bug: if auth user already exists, `onAuthStateChanged` won't fire again
        // just because username changed. So we init UI immediately.
        if (auth.currentUser) {
          initAppAfterLogin();
        } else {
          checkLoginStatus();
        }
      };

      window.logout = () => {
        localStorage.removeItem("loto_username");
        // do NOT remove per-username ids; user may log back in with same name.
        location.reload();
      };

      window.setTheme = (theme) => {
        currentTheme = theme;
        const wrapper = document.getElementById("ticket-preview-wrapper");
        wrapper.className = `theme-${theme} w-full flex justify-center`;

        // Update active button style
        const btns = document.querySelectorAll(
          "#view-generate button[class*='h-10']"
        );
        btns.forEach((btn) => {
          if (btn.onclick.toString().includes(theme)) {
            btn.classList.add("ring-2", "ring-offset-2", "ring-gray-400");
          } else {
            btn.classList.remove("ring-2", "ring-offset-2", "ring-gray-400");
          }
        });
      };

      window.generateRandomTicket = () => {
        const matrix = Array(9)
          .fill(null)
          .map(() => Array(9).fill(null));
        let distribution = Array(9)
          .fill(null)
          .map(() => Array(9).fill(0));
        let colCounts = Array(9).fill(0);

        let success = false;
        let attempts = 0;

        while (!success && attempts < 500) {
          attempts++;
          distribution = Array(9)
            .fill(null)
            .map(() => Array(9).fill(0));
          colCounts = Array(9).fill(0);

          let fail = false;
          for (let r = 0; r < 9; r++) {
            let possibleCols = [0, 1, 2, 3, 4, 5, 6, 7, 8].filter(
              (c) => colCounts[c] < 5
            );
            if (possibleCols.length < 5) {
              fail = true;
              break;
            }
            possibleCols.sort(() => Math.random() - 0.5);
            let selected = possibleCols.slice(0, 5);
            selected.forEach((c) => {
              distribution[r][c] = 1;
              colCounts[c]++;
            });
          }
          if (!fail && colCounts.every((count) => count === 5)) success = true;
        }

        if (!success) return window.generateRandomTicket();

        for (let c = 0; c < 9; c++) {
          const min = c * 10 + 1;
          const max = c === 8 ? 90 : (c + 1) * 10;
          let numbers = [];
          while (numbers.length < 5) {
            let num = Math.floor(Math.random() * (max - min + 1)) + min;
            if (!numbers.includes(num)) numbers.push(num);
          }
          numbers.sort((a, b) => a - b);
          let numIdx = 0;
          for (let r = 0; r < 9; r++) {
            if (distribution[r][c] === 1) matrix[r][c] = numbers[numIdx++];
          }
        }

        currentTicket = matrix;
        isCurrentTicketSaved = false; // Reset save status

        renderGrid("loto-grid", matrix);
        document.getElementById("btn-confirm").disabled = false;
        document.getElementById("btn-download-img").disabled = false;
        document.getElementById("preview-user").textContent = username;
        document.getElementById("preview-date").textContent =
          new Date().toLocaleString();
        document.getElementById("preview-id").textContent = Math.random()
          .toString(36)
          .substr(2, 6)
          .toUpperCase();
      };

      function getColumnRange(col) {
        const c = Number(col);
        const min = c * 10 + 1;
        const max = c === 8 ? 90 : (c + 1) * 10;
        return { min, max };
      }

      function checkFeasibility(v, r, c) {
        const { min, max } = getColumnRange(c);

        let points = [
          { row: -1, val: min - 1 },
          { row: 9, val: max + 1 },
        ];

        for (let i = 0; i < 9; i++) {
          if (i === r) continue;
          if (customMatrix[i][c] !== null) {
            points.push({ row: i, val: customMatrix[i][c] });
          }
        }

        points.push({ row: r, val: v });
        points.sort((a, b) => a.row - b.row);

        let totalCapacity = 0;
        for (let i = 0; i < points.length - 1; i++) {
          let p1 = points[i];
          let p2 = points[i + 1];

          if (p1.val >= p2.val) return false;

          let valGap = p2.val - p1.val - 1;
          let rowGap = p2.row - p1.row - 1;

          if (rowGap > 0) {
            totalCapacity += Math.min(valGap, rowGap);
          }
        }

        let countFilled = points.length - 2;
        let needed = 5 - countFilled;

        if (needed < 0) return false;

        return totalCapacity >= needed;
      }

      function getValidNumbersForCell(row, col) {
        const r = Number(row);
        const c = Number(col);
        const { min, max } = getColumnRange(c);

        let prevVal = null;
        for (let i = r - 1; i >= 0; i--) {
          if (customMatrix[i][c] != null) {
            prevVal = customMatrix[i][c];
            break;
          }
        }
        let nextVal = null;
        for (let i = r + 1; i < 9; i++) {
          if (customMatrix[i][c] != null) {
            nextVal = customMatrix[i][c];
            break;
          }
        }

        const inColumn = customMatrix.map((rowArr) => rowArr[c]);
        const currentVal = customMatrix[r][c];

        const valid = [];
        for (let v = min; v <= max; v++) {
          if (prevVal != null && v <= prevVal) continue;
          if (nextVal != null && v >= nextVal) continue;
          if (
            inColumn.some((val, idx) => idx !== r && val != null && val === v)
          ) {
            continue;
          }

          if (!checkFeasibility(v, r, c)) continue;

          valid.push(v);
        }

        if (currentVal != null && !valid.includes(currentVal)) {
          if (checkFeasibility(currentVal, r, c)) {
            valid.push(currentVal);
            valid.sort((a, b) => a - b);
          }
        }

        return valid;
      }

      function openNumberPicker(row, col, clientX, clientY) {
        currentPickerCell = { row, col };
        const picker = document.getElementById("custom-number-picker");
        const grid = document.getElementById("custom-number-picker-grid");
        if (!picker || !grid) {
          return;
        }

        // NEW LOGIC: Check count before showing picker if cell is empty
        const isCellEmpty = customMatrix[row][col] == null;

        // Count numbers in this row
        const rowCount = customMatrix[row].filter((v) => v != null).length;
        if (isCellEmpty && rowCount >= 5) {
          showToast(`Hàng ${row + 1} đã đủ 5 số! Xóa bớt nếu muốn thay đổi.`);
          return;
        }

        // Count numbers in this column
        let colCount = 0;
        for (let r = 0; r < 9; r++) {
          if (customMatrix[r][col] != null) colCount++;
        }
        if (isCellEmpty && colCount >= 5) {
          showToast(`Cột ${col + 1} đã đủ 5 số! Xóa bớt nếu muốn thay đổi.`);
          return;
        }

        const validNumbers = getValidNumbersForCell(row, col);
        if (!validNumbers.length) {
          showToast("Không còn số hợp lệ cho ô này (để đảm bảo đủ 5 số/cột).");
          return;
        }

        grid.innerHTML = "";
        validNumbers.forEach((v) => {
          const btn = document.createElement("button");
          btn.textContent = v;
          btn.className =
            "px-2 py-1 rounded text-center bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-xs font-semibold";
          btn.onclick = (e) => {
            e.stopPropagation();
            customMatrix[row][col] = v;
            renderCustomGrid();
            closeNumberPicker();
          };
          grid.appendChild(btn);
        });

        const offset = 10;
        let left = clientX + offset;
        let top = clientY + offset;
        const pickerWidth = 170;
        const pickerHeight = 160;
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        if (left + pickerWidth > vw) left = vw - pickerWidth - offset;
        if (top + pickerHeight > vh) top = vh - pickerHeight - offset;
        picker.style.left = `${left}px`;
        picker.style.top = `${top}px`;

        picker.classList.remove("hidden");
      }

      function closeNumberPicker() {
        const picker = document.getElementById("custom-number-picker");
        if (picker) picker.classList.add("hidden");
        currentPickerCell = null;
      }

      // Close picker when clicking outside
      window.addEventListener("click", (e) => {
        const picker = document.getElementById("custom-number-picker");
        if (
          picker &&
          !picker.classList.contains("hidden") &&
          !picker.contains(e.target)
        ) {
          closeNumberPicker();
        }
      });

      function renderCustomGrid() {
        const grid = document.getElementById("loto-grid-custom");
        if (!grid) return;
        grid.innerHTML = "";
        customMatrix.forEach((row, r) => {
          row.forEach((cell, c) => {
            const div = document.createElement("div");
            div.className = `loto-cell rounded-sm ${
              cell != null ? "has-number" : ""
            } cursor-pointer select-none`;
            div.textContent = cell != null ? cell : "";
            if (cell != null) {
              div.style.backgroundColor = customColor;
              div.style.color = "#ffffff";
              div.style.borderColor = customColor;
            } else {
              div.style.backgroundColor = "#ffffff";
            }
            div.dataset.row = r.toString();
            div.dataset.col = c.toString();
            div.addEventListener("click", (e) => {
              e.stopPropagation();
              openNumberPicker(r, c, e.clientX, e.clientY);
            });
            grid.appendChild(div);
          });
        });
      }

      function renderGrid(id, matrix) {
        const grid = document.getElementById(id);
        if (!grid) return;
        grid.innerHTML = "";
        matrix.forEach((row) => {
          row.forEach((cell) => {
            const div = document.createElement("div");
            div.className = `loto-cell rounded-sm ${cell ? "has-number" : ""}`;
            div.textContent = cell || "";
            grid.appendChild(div);
          });
        });
      }

      window.confirmTicket = async () => {
        if (!currentTicket) return;
        if (isCurrentTicketSaved) return showToast("Vé này đã được lưu rồi!");

        try {
          document.getElementById("btn-confirm").disabled = true; // Disable ngay lập tức
          const ticketId = push(ref(rtdb, RTDB_PATH)).key; // Generate key trước
          await set(ref(rtdb, `${RTDB_PATH}/${ticketId}`), {
            userId,
            username,
            matrix: JSON.stringify(currentTicket),
            theme: currentTheme,
            createdAt: Date.now(),
          });
          isCurrentTicketSaved = true;
          showToast("Đã lưu vé thành công!");
          window.switchTab("history");
        } catch (e) {
          console.error(e);
          document.getElementById("btn-confirm").disabled = false;
          showToast("Lỗi khi lưu vé!");
        }
      };

      window.setCustomColor = (color) => {
        customColor = color || "#ff0000";
        renderCustomGrid();
      };

      window.resetCustomTicket = () => {
        customMatrix = Array(9)
          .fill(null)
          .map(() => Array(9).fill(null));
        renderCustomGrid();
        const btnDownload = document.getElementById("btn-download-custom-img");
        if (btnDownload) btnDownload.disabled = true;
        document.getElementById("custom-preview-date").textContent =
          "--/--/----";
        document.getElementById("custom-preview-user").textContent =
          username || "...";
        document.getElementById("custom-preview-id").textContent = "CUSTOM";
      };

      window.validateAndPreviewCustomTicket = () => {
        // Kiểm tra đủ 5 số mỗi hàng
        for (let r = 0; r < 9; r++) {
          const countRow = customMatrix[r].filter((v) => v != null).length;
          if (countRow !== 5) {
            return showToast(
              `Hàng ${
                r + 1
              } hiện có ${countRow} số. Mỗi hàng phải có đúng 5 số.`
            );
          }
        }

        // Kiểm tra đủ 5 số mỗi cột & tăng dần từ trên xuống
        for (let c = 0; c < 9; c++) {
          let colVals = [];
          for (let r = 0; r < 9; r++) {
            const v = customMatrix[r][c];
            if (v != null) colVals.push(v);
          }
          if (colVals.length !== 5) {
            return showToast(
              `Cột ${c + 1} hiện có ${
                colVals.length
              } số. Mỗi cột phải có đúng 5 số.`
            );
          }
          for (let i = 1; i < colVals.length; i++) {
            if (colVals[i] <= colVals[i - 1]) {
              return showToast(
                `Trong cột ${c + 1}, các số phải tăng dần từ trên xuống dưới.`
              );
            }
          }
        }

        // Nếu hợp lệ, cập nhật thông tin preview và cho phép tải ảnh
        document.getElementById("custom-preview-user").textContent =
          username || "...";
        document.getElementById("custom-preview-date").textContent =
          new Date().toLocaleString();
        document.getElementById("custom-preview-id").textContent = Math.random()
          .toString(36)
          .substr(2, 6)
          .toUpperCase();

        const btnDownload = document.getElementById("btn-download-custom-img");
        if (btnDownload) btnDownload.disabled = false;

        showToast("Vé tùy chọn hợp lệ! Bạn có thể tải ảnh vé.");
      };

      // Gắn sự kiện cho nút "Xóa ô" trong popup chọn số (chỉ dùng cho Tự Tạo Vé)
      const pickerClearBtn = document.getElementById(
        "custom-number-picker-clear"
      );
      if (pickerClearBtn) {
        pickerClearBtn.onclick = (e) => {
          e.stopPropagation();
          if (!currentPickerCell) {
            closeNumberPicker();
            return;
          }
          const { row, col } = currentPickerCell;
          customMatrix[row][col] = null;
          renderCustomGrid();
          closeNumberPicker();
        };
      }

      // Xóa vé Logic
      window.askDelete = (id) => {
        pendingDeleteId = id;
        document.getElementById("modal-confirm").classList.remove("hidden");
      };

      window.closeConfirm = () => {
        pendingDeleteId = null;
        document.getElementById("modal-confirm").classList.add("hidden");
      };

      document.getElementById("btn-confirm-delete").onclick = async () => {
        if (!pendingDeleteId) return;
        try {
          await remove(ref(rtdb, `${RTDB_PATH}/${pendingDeleteId}`));
          showToast("Đã xóa vé thành công!");
          window.closeConfirm();
        } catch (e) {
          showToast("Không thể xóa vé này!");
        }
      };

      function listenToTickets() {
        onValue(ref(rtdb, RTDB_PATH), (snapshot) => {
          const data = snapshot.val();
          allTickets = data
            ? Object.keys(data).map((k) => ({ id: k, ...data[k] }))
            : [];
          allTickets.sort((a, b) => b.createdAt - a.createdAt);
          updateUI();
        });
      }

      function updateUI() {
        // Stats
        if (isAdmin) {
          document.getElementById("stat-total-tickets").textContent =
            allTickets.length;
          const uniqueUsers = new Set(allTickets.map((t) => t.username)).size;
          document.getElementById("stat-total-users").textContent = uniqueUsers;
          document.getElementById("stat-last-user").textContent =
            allTickets.length > 0 ? allTickets[0].username : "---";

          // Detailed stats (admin)
          const byUser = {};
          const byTheme = { white: 0, red: 0, blue: 0, green: 0, purple: 0 };
          const now = Date.now();
          const startOfToday = new Date();
          startOfToday.setHours(0, 0, 0, 0);
          const todayMs = startOfToday.getTime();
          const weekMs = now - 7 * 24 * 60 * 60 * 1000;
          let ticketsToday = 0;
          let tickets7d = 0;

          allTickets.forEach((t) => {
            const name = (t.username || "---").trim() || "---";
            byUser[name] = (byUser[name] || 0) + 1;
            const th = (t.theme || "white").toLowerCase();
            if (byTheme[th] != null) byTheme[th]++;
            if (t.createdAt >= todayMs) ticketsToday++;
            if (t.createdAt >= weekMs) tickets7d++;
          });

          const topUsers = Object.entries(byUser)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 8);
          const topName = topUsers[0]?.[0] || "---";
          const topCount = topUsers[0]?.[1] || 0;

          document.getElementById("stat-tickets-today").textContent =
            ticketsToday;
          document.getElementById("stat-tickets-7d").textContent = tickets7d;
          document.getElementById("stat-top-user").textContent = topName;
          document.getElementById("stat-top-user-count").textContent = topCount;

          const themeTotal = Object.values(byTheme).reduce((a, b) => a + b, 0);
          const setBar = (idFill, idText, count) => {
            const pct = themeTotal ? Math.round((count / themeTotal) * 100) : 0;
            document.getElementById(idFill).style.width = `${pct}%`;
            document.getElementById(idText).textContent = `${count} (${pct}%)`;
          };
          setBar("theme-red-fill", "theme-red-text", byTheme.red);
          setBar("theme-blue-fill", "theme-blue-text", byTheme.blue);
          setBar("theme-green-fill", "theme-green-text", byTheme.green);
          setBar("theme-purple-fill", "theme-purple-text", byTheme.purple);
          setBar("theme-white-fill", "theme-white-text", byTheme.white);

          const userList = document.getElementById("admin-user-breakdown");
          if (userList) {
            userList.innerHTML = "";
            const max = topUsers[0]?.[1] || 1;
            topUsers.forEach(([name, count]) => {
              const row = document.createElement("div");
              row.className =
                "flex items-center gap-3 bg-gray-50 rounded-lg px-3 py-2 border";
              const pct = Math.round((count / max) * 100);
              row.innerHTML = `
                <div class="min-w-0 flex-1">
                  <div class="flex justify-between items-center gap-3">
                    <div class="font-bold text-gray-800 truncate">${name}</div>
                    <div class="text-xs text-gray-500 whitespace-nowrap">${count} vé</div>
                  </div>
                  <div class="w-full h-2 bg-gray-200 rounded-full mt-2 overflow-hidden">
                    <div class="h-2 bg-indigo-500 rounded-full" style="width:${pct}%"></div>
                  </div>
                </div>
              `;
              userList.appendChild(row);
            });
          }
        }

        // History UI (Kho vé của tôi)
        const historyList = document.getElementById("history-list");
        if (historyList) {
          // Prefer username-based filtering to avoid cross-user leakage on shared devices.
          const normName = (username || "").trim().toLowerCase();
          const myTickets = allTickets.filter((t) => {
            const tName = (t.username || "").trim().toLowerCase();
            if (normName) return tName === normName;
            return t.userId === userId;
          });
          document.getElementById(
            "history-count"
          ).textContent = `${myTickets.length} vé`;

          historyList.innerHTML = myTickets.length
            ? ""
            : '<div class="col-span-full flex flex-col items-center justify-center py-12 text-gray-400"><i class="fa-solid fa-box-open text-4xl mb-3"></i><p>Bạn chưa lưu vé nào.</p></div>';

          myTickets.forEach((t) => {
            const themeClass = `theme-${t.theme || "red"}`;
            const card = document.createElement("div");
            card.className = `${themeClass} bg-white p-4 rounded-xl shadow-sm border ticket-border hover:shadow-md transition-shadow relative group`;
            card.innerHTML = `
              <div class="flex justify-between items-center mb-3 ticket-header border-b pb-2">
                <span class="text-[10px] font-mono opacity-70">${new Date(
                  t.createdAt
                ).toLocaleDateString()}</span>
                <div class="flex gap-2">
                    <button onclick="window.askDelete('${
                      t.id
                    }')" class="w-6 h-6 rounded flex items-center justify-center text-red-500 hover:bg-red-50 transition" title="Xóa vé">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                    <button onclick="window.downloadTicketImage('grid-${
                      t.id
                    }', 'Loto_${
              t.id
            }.png')" class="w-6 h-6 rounded flex items-center justify-center text-indigo-600 hover:bg-indigo-50 transition" title="Tải ảnh">
                        <i class="fa-solid fa-download text-xs"></i>
                    </button>
                </div>
              </div>
              <div id="grid-${
                t.id
              }" class="grid grid-cols-9 gap-[1px] grid-bg border p-[1px]"></div>
              <div class="mt-2 text-center text-[10px] text-gray-400 font-mono">ID: ${t.id
                .substr(-6)
                .toUpperCase()}</div>
            `;
            historyList.appendChild(card);
            renderGrid(`grid-${t.id}`, JSON.parse(t.matrix));
          });
        }

        // Admin Table UI
        if (isAdmin) {
          window.filterAdminTable(
            document.querySelector("#view-admin input").value
          );
        }
      }

      window.filterAdminTable = (keyword) => {
        if (!isAdmin) return;
        const tbody = document.getElementById("admin-table-body");
        const emptyState = document.getElementById("admin-empty-state");
        const term = keyword.toLowerCase().trim();

        const filtered = allTickets.filter((t) =>
          t.username.toLowerCase().includes(term)
        );

        tbody.innerHTML = "";
        if (filtered.length === 0) {
          emptyState.classList.remove("hidden");
        } else {
          emptyState.classList.add("hidden");
          filtered.forEach((t) => {
            const themeName = (t.theme || "red").toUpperCase();
            const badgeColor =
              t.theme === "white"
                ? "bg-gray-100 text-gray-800"
                : t.theme === "blue"
                ? "bg-blue-100 text-blue-800"
                : t.theme === "green"
                ? "bg-green-100 text-green-800"
                : t.theme === "purple"
                ? "bg-purple-100 text-purple-800"
                : "bg-red-100 text-red-800";

            const tr = document.createElement("tr");
            tr.className = "hover:bg-gray-50 transition";
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-bold text-gray-900">${
                      t.username
                    }</div>
                    <div class="text-xs text-gray-400">ID: ${t.id}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${badgeColor}">
                      ${themeName}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">
                    ${new Date(t.createdAt).toLocaleString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                  <div class="flex justify-center gap-3">
                      <button onclick="window.downloadAdminTicket('${
                        t.id
                      }')" class="text-indigo-600 hover:text-indigo-900" title="Tải ảnh">
                        <i class="fa-solid fa-download"></i>
                      </button>
                      <button onclick="window.askDelete('${
                        t.id
                      }')" class="text-red-600 hover:text-red-900" title="Xóa vé">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                  </div>
                </td>
              `;
            tbody.appendChild(tr);
          });
        }
      };

      // Export functions unchanged but optimized
      window.exportToExcel = () => {
        if (allTickets.length === 0) return showToast("Không có dữ liệu!");
        const wb = XLSX.utils.book_new();
        const groups = {};
        allTickets.forEach((t) => {
          if (!groups[t.username]) groups[t.username] = [];
          groups[t.username].push(t);
        });

        // Sheet 1: Tổng hợp toàn bộ user (hiển thị dạng bảng 9x9)
        const summaryRows = [[`TỔNG HỢP VÉ LOTO - TOÀN BỘ NGƯỜI CHƠI`], []];
        allTickets.forEach((t, idx) => {
          summaryRows.push([
            `#${idx + 1} ${t.username}`,
            // `User: ${t.username}`,
            // `ID: ${t.id}`,
            // `Ngày: ${new Date(t.createdAt).toLocaleString()}`,
            // `Màu: ${t.theme || "white"}`,
          ]);
          // summaryRows.push([
          //   "C1",
          //   "C2",
          //   "C3",
          //   "C4",
          //   "C5",
          //   "C6",
          //   "C7",
          //   "C8",
          //   "C9",
          // ]);
          const matrix = JSON.parse(t.matrix);
          matrix.forEach((r) => summaryRows.push(r.map((c) => c || "")));
          summaryRows.push([]);
        });
        XLSX.utils.book_append_sheet(
          wb,
          XLSX.utils.aoa_to_sheet(summaryRows),
          "TONG_HOP"
        );

        Object.keys(groups).forEach((name) => {
          let rows = [[`DANH SÁCH VÉ LOTO - ${name.toUpperCase()}`], []];
          groups[name].forEach((t, i) => {
            // rows.push([
            //   `VÉ #${i + 1} (ID: ${t.id})`,
            //   `Ngày: ${new Date(t.createdAt).toLocaleString()}`,
            //   `Màu: ${t.theme || "red"}`,
            // ]);
            // rows.push(["C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9"]);
            const matrix = JSON.parse(t.matrix);
            matrix.forEach((r) => rows.push(r.map((c) => c || "")));
            rows.push([]);
          });
          const sheetName = name.replace(/[\\/:?*\[\]]/g, "").substring(0, 30);
          const ws = XLSX.utils.aoa_to_sheet(rows);
          XLSX.utils.book_append_sheet(wb, ws, sheetName || "Sheet1");
        });

        XLSX.writeFile(
          wb,
          `Loto_TongHop_${new Date()
            .toLocaleDateString()
            .replace(/\//g, "-")}.xlsx`
        );
        showToast("Đã tải xuống file Excel!");
      };

      window.downloadAllTickets = async () => {
        if (!allTickets.length) return;
        const container = document.getElementById("bulk-render-container");
        showToast("Đang chuẩn bị tải... Vui lòng đợi");

        for (const t of allTickets) {
          const themeClass = `theme-${t.theme || "red"}`;
          container.innerHTML = `
            <div id="bulk-wrapper" class="${themeClass} w-full p-2">
                <div id="bulk-temp" class="ticket-container ticket-border border-2 rounded p-4 shadow-xl w-full">
                  <div class="text-center mb-4 border-b ticket-header pb-2">
                    <h3 class="text-xl font-black uppercase">Vé Loto</h3>
                   
                    <p class="text-xs font-bold">${t.username}</p>
                  </div>
                  <div id="bulk-grid" class="grid grid-cols-9 gap-1 grid-bg p-1 border rounded"></div>
                </div>
            </div>
          `;
          renderGrid("bulk-grid", JSON.parse(t.matrix));

          await new Promise((r) => setTimeout(r, 150)); // Slightly faster
          const canvas = await html2canvas(
            container.querySelector("#bulk-temp"),
            { scale: 2 }
          );
          const link = document.createElement("a");
          link.download = `Loto_${t.username}_${t.id}.png`;
          link.href = canvas.toDataURL();
          link.click();
        }
        showToast("Hoàn tất tải ảnh!");
      };

      window.downloadAdminTicket = (id) => {
        const ticket = allTickets.find((t) => t.id === id);
        if (!ticket) return;
        const themeClass = `theme-${ticket.theme || "red"}`;
        const container = document.getElementById("bulk-render-container");
        container.innerHTML = `
          <div id="bulk-wrapper" class="${themeClass} w-full p-2">
              <div id="bulk-temp" class="ticket-container ticket-border border-2 rounded p-4 shadow-xl w-full">
                <div class="text-center mb-4 border-b ticket-header pb-2">
                  <h3 class="text-xl font-black uppercase">Vé Loto </h3>
                  
                  <p class="text-xs font-bold">${ticket.username}</p>
                </div>
                <div id="bulk-grid" class="grid grid-cols-9 gap-1 grid-bg p-1 border rounded"></div>
              </div>
          </div>
        `;
        renderGrid("bulk-grid", JSON.parse(ticket.matrix));
        setTimeout(async () => {
          const canvas = await html2canvas(
            container.querySelector("#bulk-temp"),
            { scale: 2 }
          );
          const link = document.createElement("a");
          link.download = `Loto_${ticket.username}.png`;
          link.href = canvas.toDataURL();
          link.click();
        }, 100);
      };

      // Utils
      window.switchTab = (name) => {
        if (name === "admin" && !isAdmin) {
          showToast("Bạn không có quyền mở tab Admin!");
          name = "generate";
        }
        ["generate", "custom", "history", "admin"].forEach((t) => {
          document.getElementById(`view-${t}`)?.classList.add("hidden");
          const tab = document.getElementById(`tab-${t}`);
          if (tab)
            tab.className =
              "tab-inactive py-3 px-6 font-medium text-sm whitespace-nowrap transition-colors duration-200";
        });
        document.getElementById(`view-${name}`)?.classList.remove("hidden");
        const activeTab = document.getElementById(`tab-${name}`);
        if (activeTab)
          activeTab.className =
            "tab-active py-3 px-6 font-bold text-sm whitespace-nowrap transition-colors duration-200";

        if (name === "custom") {
          if (!isCustomGridInitialized) {
            isCustomGridInitialized = true;
            renderCustomGrid();
          }
          document.getElementById("custom-preview-user").textContent =
            username || "...";
        }
      };

      function showToast(m) {
        const t = document.getElementById("toast");
        const msg = document.getElementById("toast-msg");
        msg.textContent = m;
        t.classList.remove("translate-y-24", "opacity-0");
        setTimeout(() => t.classList.add("translate-y-24", "opacity-0"), 3000);
      }

      window.downloadTicketImage = async (id, fileName) => {
        const el = document.getElementById(id);
        const canvas = await html2canvas(el, { scale: 2 });
        const link = document.createElement("a");
        link.download = fileName || `Loto_${Date.now()}.png`;
        link.href = canvas.toDataURL();
        link.click();
      };

      checkLoginStatus();
    </script>
  </body>
</html>
